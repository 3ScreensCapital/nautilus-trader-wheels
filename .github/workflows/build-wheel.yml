name: build-wheels

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "nautilus_trader commit SHA to build"
        required: false
        default: "e8e685e48b2fd47c20669ae9842dab85fba71ce7"
      architectures:
        description: "Architectures to build (arm64, x86_64, both)"
        required: false
        default: "both"
  schedule:
    - cron: "0 4 * * 0" # Sundays at 04:00 UTC

permissions:
  contents: write
  packages: write

env:
  NAUTILUS_COMMIT: ${{ github.event.inputs.commit_sha || 'e8e685e48b2fd47c20669ae9842dab85fba71ce7' }}
  PYTHON_VERSION: "3.12"
  BUILD_MODE: release
  CARGO_BUILD_JOBS: 1

jobs:
  build-arm64:
    name: Build ARM64 wheel
    if: ${{ github.event.inputs.architectures != 'x86_64' }}
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout nautilus_trader
        uses: actions/checkout@v4
        with:
          repository: nautechsystems/nautilus_trader
          ref: ${{ env.NAUTILUS_COMMIT }}
          fetch-depth: 1

      - name: Install system dependencies
        run: |
          sudo apt-get update -o Acquire::Retries=5
          sudo apt-get install -y curl clang git make pkg-config python3-dev libpython3-dev -o Acquire::Retries=5
          sudo apt-get clean

      - name: Install Cap'n Proto
        run: bash scripts/install-capnp.sh

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Rust toolchain
        run: bash scripts/ci/install-rust.sh

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy,rustfmt
          override: true

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Build wheel (ARM64)
        run: |
          PYTHON_LIB_DIR=$(python3 -c 'import sysconfig; print(sysconfig.get_config_var("LIBDIR"))')
          PYTHON_VERSION=$(python3 -c 'import platform; print(".".join(platform.python_version_tuple()[:2]))')

          export CARGO_BUILD_JOBS=1
          export LD_LIBRARY_PATH="/usr/lib/aarch64-linux-gnu:$PYTHON_LIB_DIR:$LD_LIBRARY_PATH"
          export LIBRARY_PATH="/usr/lib/aarch64-linux-gnu:$PYTHON_LIB_DIR:$LIBRARY_PATH"
          export PYO3_PYTHON=$(which python${{ env.PYTHON_VERSION }})
          export RUSTFLAGS="-C link-arg=-L${PYTHON_LIB_DIR} -C link-arg=-lpython${PYTHON_VERSION}"
          export CC=clang
          export CXX=clang++

          uv build --wheel
          ls -lh dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: nautilus_trader-arm64-wheel
          path: dist/nautilus_trader-*.whl
          retention-days: 90

  build-x86_64:
    name: Build x86_64 wheel
    if: ${{ github.event.inputs.architectures != 'arm64' }}
    runs-on: ubuntu-22.04
    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout nautilus_trader
        uses: actions/checkout@v4
        with:
          repository: nautechsystems/nautilus_trader
          ref: ${{ env.NAUTILUS_COMMIT }}
          fetch-depth: 1

      - name: Install system dependencies
        run: |
          sudo apt-get update -o Acquire::Retries=5
          sudo apt-get install -y curl clang git make pkg-config python3-dev libpython3-dev -o Acquire::Retries=5
          sudo apt-get clean

      - name: Install Cap'n Proto
        run: bash scripts/install-capnp.sh

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Rust toolchain
        run: bash scripts/ci/install-rust.sh

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy,rustfmt
          override: true

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Build wheel (x86_64)
        run: |
          PYTHON_LIB_DIR=$(python3 -c 'import sysconfig; print(sysconfig.get_config_var("LIBDIR"))')
          PYTHON_VERSION=$(python3 -c 'import platform; print(".".join(platform.python_version_tuple()[:2]))')

          export CARGO_BUILD_JOBS=1
          export LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:$PYTHON_LIB_DIR:$LD_LIBRARY_PATH"
          export LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:$PYTHON_LIB_DIR:$LIBRARY_PATH"
          export PYO3_PYTHON=$(which python${{ env.PYTHON_VERSION }})
          export RUSTFLAGS="-C link-arg=-L${PYTHON_LIB_DIR} -C link-arg=-lpython${PYTHON_VERSION}"
          export CC=clang
          export CXX=clang++

          uv build --wheel
          ls -lh dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: nautilus_trader-x86_64-wheel
          path: dist/nautilus_trader-*.whl
          retention-days: 90

  release:
    name: Create release with wheels
    needs: [build-arm64, build-x86_64]
    if: ${{ always() && (needs.build-arm64.result == 'success' || needs.build-x86_64.result == 'success') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels/
          pattern: nautilus_trader-*-wheel

      - name: Create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NAUTILUS_COMMIT: ${{ env.NAUTILUS_COMMIT }}
        run: |
          TAG="build-$(date +%Y%m%d)-${NAUTILUS_COMMIT:0:8}"
          
          # Collect all wheels
          find wheels/ -name '*.whl' -exec cp {} /tmp/ \;
          ls -lh /tmp/*.whl
          
          # Create or update release
          gh release create "$TAG" \
            --title "nautilus_trader wheels (${NAUTILUS_COMMIT:0:8})" \
            --notes "Built from nautechsystems/nautilus_trader@${NAUTILUS_COMMIT}" \
            /tmp/*.whl || \
          gh release upload "$TAG" /tmp/*.whl --clobber
